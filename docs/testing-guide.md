# テスト・デバッグ手順書

このドキュメントでは、フェーズ7のテスト・デバッグ手順を説明します。

## 事前準備

### 1. 環境変数の設定

`.env.local`ファイルに実際のAPIキーを設定してください。

```bash
# .env.local
ANTHROPIC_API_KEY=sk-ant-xxxxx  # 実際のAnthropicAPIキーを設定
DATABASE_URL="mongodb://admin:password@localhost:27017/chatbot?authSource=admin"
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 2. Dockerの起動

Dockerデスクトップアプリを起動してください。

### 3. 依存パッケージのインストール

```bash
npm install
```

## フェーズ7.1: ローカル環境での動作確認

### ステップ1: Docker ComposeでローカルMongoDB起動

```bash
docker-compose up -d
```

起動確認：
```bash
docker-compose ps
```

MongoDBが起動していることを確認してください。

### ステップ2: データベース接続テスト

```bash
npm run db:test
```

成功メッセージが表示されることを確認してください。

### ステップ3: Prisma Clientの生成

```bash
npx prisma generate
```

### ステップ4: Next.js開発サーバー起動

```bash
npm run dev
```

ブラウザで http://localhost:3000 にアクセスしてください。

### ステップ5: チャット送受信の動作確認

1. ブラウザでチャット画面を開く
2. メッセージを入力して送信
3. AIからのレスポンスが表示されることを確認

**確認項目：**
- [ ] メッセージが送信できる
- [ ] AIからレスポンスが返ってくる
- [ ] メッセージが正しく表示される
- [ ] ユーザーメッセージとAIメッセージが区別されている

### ステップ6: ストリーミング表示の確認

1. 長めの質問を送信（例: "Next.jsについて詳しく教えてください"）
2. レスポンスが徐々に表示されることを確認

**確認項目：**
- [ ] テキストが一文字ずつ表示される
- [ ] スムーズに表示される
- [ ] 表示が完了するまでローディング状態が表示される
- [ ] 自動スクロールが機能する

### ステップ7: エラーハンドリングの確認

#### 7-1. API接続エラーのテスト

1. 開発サーバーを停止
2. ブラウザでメッセージを送信
3. エラーメッセージが表示されることを確認

**確認項目：**
- [ ] エラーメッセージが表示される
- [ ] ユーザーに分かりやすいメッセージになっている
- [ ] エラー後も再送信できる

#### 7-2. 無効なAPIキーのテスト

1. `.env.local`のAPIキーを無効な値に変更
2. 開発サーバーを再起動
3. メッセージを送信
4. エラーハンドリングを確認

**確認項目：**
- [ ] エラーメッセージが表示される
- [ ] アプリがクラッシュしない

## フェーズ7.2: エッジケースのテスト

### テスト1: 長文メッセージの送信

非常に長いメッセージ（1000文字以上）を送信してテスト。

**確認項目：**
- [ ] 長文が正常に送信される
- [ ] 文字数制限がある場合、適切にエラーが表示される
- [ ] レスポンスが正常に返ってくる
- [ ] UIが崩れない

### テスト2: 連続送信のテスト

短時間に複数のメッセージを連続で送信。

**確認項目：**
- [ ] 送信中は次の送信がブロックされる
- [ ] すべてのメッセージが正しく処理される
- [ ] レスポンスが混在しない
- [ ] ローディング状態が正しく表示される

### テスト3: 空メッセージの送信防止

空白のみのメッセージを送信しようとする。

**確認項目：**
- [ ] 空メッセージが送信できない
- [ ] 送信ボタンが無効化されている
- [ ] エラーメッセージが表示される（または送信がブロックされる）

### テスト4: 特殊文字の処理

以下の特殊文字を含むメッセージを送信：
- HTMLタグ: `<script>alert('test')</script>`
- 絵文字: `こんにちは 😊 👋`
- 改行を含むメッセージ

**確認項目：**
- [ ] HTMLタグがエスケープされる（XSS対策）
- [ ] 絵文字が正しく表示される
- [ ] 改行が正しく表示される

### テスト5: ネットワークエラー時の挙動

開発者ツールでネットワークをオフラインにしてテスト。

**確認項目：**
- [ ] エラーメッセージが表示される
- [ ] ローディング状態が解除される
- [ ] 再試行が可能

## フェーズ7.3: パフォーマンステスト

### テスト1: レスポンス速度

複数のメッセージを送信して、レスポンス時間を測定。

**確認項目：**
- [ ] 初回レスポンスが3秒以内に開始される
- [ ] ストリーミングがスムーズに動作する

### テスト2: ストリーミングのスムーズさ

長いレスポンスを生成する質問を送信。

**確認項目：**
- [ ] テキストが途切れずに表示される
- [ ] カクつきがない
- [ ] CPUやメモリの使用率が異常に高くならない

### テスト3: メモリリーク

1. ブラウザの開発者ツールを開く
2. パフォーマンスタブでメモリを記録
3. 10回以上メッセージを送受信
4. メモリ使用量を確認

**確認項目：**
- [ ] メモリ使用量が右肩上がりに増加し続けない
- [ ] GCが正常に動作している
- [ ] チャットクリア機能でメモリが解放される

### テスト4: UI/UXのテスト

**確認項目：**
- [ ] モバイル画面で正しく表示される
- [ ] タブレット画面で正しく表示される
- [ ] デスクトップ画面で正しく表示される
- [ ] 入力フィールドがフォーカスされる
- [ ] スクロールが自然
- [ ] ボタンのホバー状態が適切
- [ ] ローディングインジケーターが見やすい

## テスト完了後

すべてのテストが完了したら、以下を確認してください：

1. **ブラウザコンソール**にエラーがないことを確認
2. **ターミナル**のサーバーログにエラーがないことを確認
3. **Docker ログ**にエラーがないことを確認

```bash
# Dockerログの確認
docker-compose logs
```

## トラブルシューティング

### MongoDB接続エラー

```bash
# MongoDBコンテナを再起動
docker-compose down
docker-compose up -d

# ログを確認
docker-compose logs mongodb
```

### Next.js起動エラー

```bash
# node_modulesを削除して再インストール
rm -rf node_modules
npm install

# キャッシュをクリア
rm -rf .next
npm run dev
```

### Prismaエラー

```bash
# Prisma Clientを再生成
npx prisma generate

# データベースをリセット（開発環境のみ）
npx prisma db push --force-reset
```

## 次のステップ

すべてのテストが成功したら、TODO.mdのフェーズ7のチェックボックスをすべてチェックしてください。
その後、フェーズ8（Docker化）に進むことができます。
